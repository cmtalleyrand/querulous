# Definitions Reference

All terms used in the Fugue Subject Analyzer, cross-referenced to code.

---

## Fugal Terms

### Subject
The primary melodic theme of a fugue. Each voice presents it in turn. Entered via the Subject ABC input field.

**Code**: Parsed by `abcParser.js:parseABC()` into `NoteEvent[]`. Stored as `subjectInput` / `subjectNotes` in `App.jsx`.

### Countersubject (CS)
A secondary melody that consistently accompanies subject entries. Must work against both subject (tonic) and answer (dominant), and should be invertible.

**Code**: Parsed identically to subject. Stored as `csInput` / `csNotes` in `App.jsx`.

### Answer
The subject transposed to the dominant (up a perfect fifth). Two types:

- **Real answer**: Exact interval-for-interval transposition.
- **Tonal answer**: Modified transposition when the subject emphasizes ^1-^5 or ^5-^1 motion. The adjustment preserves tonic-dominant polarity.

**Mutation point**: Where real transposition resumes after the tonal adjustment.

**Code**: Generated by `analysis.js:testTonalAnswer()`. Stored as `answerInput` / `answerNotes` in `App.jsx`.

### Stretto
Overlapping entries where a new voice begins the subject before the previous voice finishes. Each possible entry distance is tested as full two-voice counterpoint.

**Code**: `analysis.js:testStrettoViability()`. The comes enters at various time offsets from the dux. Each distance receives full dissonance analysis.

### Dux / Comes
In stretto and canon contexts: **dux** = the leading voice (first entry), **comes** = the following voice (delayed entry).

**Code**: Used in `StrettoViz.jsx` and stretto analysis. `duxPitch` / `comesPitch` in interval point objects.

### Double Counterpoint (Invertibility)
The ability to swap voice positions — the upper voice becomes the lower and vice versa. "At the octave" means one voice is displaced by an octave.

**Code**: `analysis.js:testDoubleCounterpoint()`. Tests original configuration (CS above) and inverted (CS below, transposed down an octave).

### Junction
The harmonic progression implied when the subject's final note connects to the answer's entry on the dominant.

| Terminal Degree | Junction | Quality |
|-----------------|----------|---------|
| ^1 | I-V | Strong |
| ^7 | vii-V | Strong |
| ^4 | IV-V | Strong |
| ^2 | ii-V | Good |
| ^3 | I-V | Good |
| ^5 | V-V | Static (problematic) |
| Other | ?-V | Unusual (problematic) |

**Code**: Evaluated in `scoring.js:scoreTonalClarity()`.

### Sequence (Melodic)
A pattern that repeats at consecutive transposition levels — not scattered motivic recurrences. Example: a 3-note figure immediately repeated a step lower, then another step lower.

Detection requires:
- Consecutive repetitions (adjacent in time)
- Interval class matching (M3/m3 treated as same "3rd" class)
- Rhythm matching (within 10% tolerance)
- Inversion equivalence (P4 up = P5 down)

**Code**: `analysis.js:detectSequences()`. Sequence ranges stored and passed to dissonance scoring for penalty mitigation.

---

## Data Structures

### NoteEvent
A single parsed note with timing and pitch information.

| Field | Type | Meaning |
|-------|------|---------|
| `pitch` | number | MIDI pitch (60 = C4, middle C) |
| `duration` | number | In quarter-note units (0.5 = eighth note) |
| `onset` | number | Beat position, 0-indexed, in quarter-note units |
| `scaleDegree` | ScaleDegree | Scale degree in the analysis key (^1, ^#4, etc.) |
| `abcNote` | string | Original ABC notation text |

**Code**: `types/music.js:NoteEvent`

### ScaleDegree
A scale degree with optional chromatic alteration.

| Field | Type | Values |
|-------|------|--------|
| `degree` | number | 1-7 |
| `alteration` | number | -1 (flat), 0 (natural), +1 (sharp) |

Display: `^1`, `^#4`, `^b7`, etc.

**Code**: `types/music.js:ScaleDegree`

### Interval
A vertical interval between two simultaneous pitches, reduced to within one octave.

| Field | Type | Meaning |
|-------|------|---------|
| `semitones` | number | 0-11 (mod 12) |
| `class` | number | 1-8 (unison through octave) |
| `quality` | string | `perfect`, `major`, `minor`, `augmented`, `diminished` |

| Semitones | Class | Quality | Consonant? |
|-----------|-------|---------|------------|
| 0 | 1 (unison) | perfect | Yes |
| 1 | 2 | minor | No |
| 2 | 2 | major | No |
| 3 | 3 | minor | Yes |
| 4 | 3 | major | Yes |
| 5 | 4 | perfect | Context-dependent* |
| 6 | 4 | augmented | No (tritone) |
| 7 | 5 | perfect | Yes |
| 8 | 6 | minor | Yes |
| 9 | 6 | major | Yes |
| 10 | 7 | minor | No |
| 11 | 7 | major | No |

*P4 is always treated as dissonant in two-voice counterpoint (one voice is always the bass). The user can override this via the P4 checkbox.

**Code**: `types/music.js:Interval`. Consonance check: `Interval.isConsonant()` — returns true for classes 1, 3, 5, 6, 8 (excluding augmented/diminished qualities).

### Simultaneity
A moment when two notes from different voices overlap in time.

| Field | Type | Meaning |
|-------|------|---------|
| `onset` | number | Beat position (quarter-note units) |
| `voice1Note` | NoteEvent | Upper voice note |
| `voice2Note` | NoteEvent | Lower voice note |
| `interval` | Interval | Vertical interval between the voices |
| `metricWeight` | number | 0-1, from `metricWeight()` |

**Code**: `types/music.js:Simultaneity`. Created by `analysis.js:findSimultaneities()`.

### MelodicMotion
Motion between consecutive notes in a single voice.

| Field | Type | Meaning |
|-------|------|---------|
| `time` | number | When the motion occurs |
| `semitones` | number | Absolute interval size |
| `direction` | number | +1 (up), -1 (down), 0 (unison) |

**Code**: `types/music.js:MelodicMotion`

---

## Internal Timing System

All timing uses **quarter-note units** (internal units):

| Duration | Internal Units |
|----------|---------------|
| Whole note | 4.0 |
| Dotted half | 3.0 |
| Half note | 2.0 |
| Dotted quarter | 1.5 |
| Quarter note | 1.0 |
| Eighth note | 0.5 |
| Sixteenth note | 0.25 |

Measures in internal units:
- 4/4: 4 units per measure (4 quarter-note beats)
- 3/4: 3 units per measure
- 6/8: 3 units per measure (2 dotted-quarter beats of 1.5 units each)
- 9/8: 4.5 units per measure (3 dotted-quarter beats)
- 12/8: 6 units per measure (4 dotted-quarter beats)
- 2/2: 4 units per measure (2 half-note beats of 2 units each)

**Code**: `formatter.js` header comment, `BeatFormatter` constructor.

### Time Position Format

`M{measure}.B{beat}.{subdivision}.{fraction}`

- M = measure number (1-indexed)
- B = beat number within measure (1-indexed)
- Subdivision = which subdivision of the beat (1-indexed)
- Fraction = position within subdivision (0-9, where 5 = midpoint)

Examples:
- `M1.B1` — downbeat of measure 1
- `M3.B3.2` — second subdivision of beat 3, measure 3
- `M3.B3.3.5` — midpoint of the 3rd eighth of beat 3, measure 3

**Code**: `formatter.js:BeatFormatter.formatBeat()`

---

## Metric System

### Compound vs Simple Meter

**Simple meters**: Beat divides in 2 (2/4, 3/4, 4/4, 5/4, 2/2, 3/2, 6/4).
**Compound meters**: Beat divides in 3 (6/8, 9/8, 12/8). Detected when numerator is divisible by 3, denominator is 8, and numerator >= 6.

Note: 3/8 is treated as simple (1 beat per measure), not compound.

**Code**: `formatter.js:BeatFormatter.isCompound`, `metricWeight()`.

### Metric Weight

A 0-1 value indicating the strength of a beat position. Used throughout the scoring system to determine how severely issues are penalized.

| Weight | Label | Severity | Description |
|--------|-------|----------|-------------|
| 1.0 | Downbeat | Strong | Beat 1 of any measure |
| 0.75 | Secondary accent | Moderate | Beat 3 in 4/4; beat 3 in 12/8 |
| 0.5 | Weak beat | Mild | Other main beats (beats 2, 4 in 4/4) |
| 0.35 | Subdivision | Light | Off-beat primary subdivision (e.g., eighth notes in 4/4) |
| 0.25 | Sub-subdivision | Light | Sixteenth-note level |
| 0.2 | Off-beat | Negligible | Other subdivisions |

Compound meter subdivisions (2nd and 3rd eighth within a dotted-quarter beat): 0.3.

**Code**: `formatter.js:metricWeight(onset, meter)`, `metricPosition()`, `metricSeverity()`.

### "On the beat"
Means the attack occurs at the beat onset (the very start of the beat), not just anywhere during the beat.

### Strong Beat (in dissonance scoring)
`metricWeight(onset) >= 0.75`. This means beat 1 and beat 3 in 4/4, or beat 1 and beat 3 in 12/8.

**Code**: `dissonanceScoring.js:isStrongBeat()` — checks `metricWeight(onset, currentMeter) >= 0.75`.

---

## Motion Types

How two voices move relative to each other between consecutive simultaneities.

| Type | Definition | Scoring Impact |
|------|-----------|----------------|
| **Contrary** | Voices move in opposite directions | Entry: +0.5 |
| **Oblique** | One voice moves, the other holds | Entry: +0.5 |
| **Similar** | Both move same direction, different intervals | Entry: -0.5 to -1.0 |
| **Parallel** | Both move same direction and same interval | Entry: -1.5 |
| **Static** | Neither voice moves | Neutral |
| **Reentry** | After a rest > 1 quarter AND > 2x last note duration | Always neutral (0) |

**From rest modifier**: When a voice enters from a rest, similar/parallel penalties are halved (asynchronous motion is less audible).

**Code**: `dissonanceScoring.js:getMotionType()` (lines 309-358).

---

## Interval Magnitude Classification

How melodic intervals (within a single voice) are categorized by size.

| Type | Semitones | Examples |
|------|-----------|---------|
| Unison | 0 | Repeated note |
| Step | 1-2 | m2, M2 |
| Skip | 3-4 | m3, M3 |
| Perfect leap | 5 or 7 | P4, P5 |
| Octave | 12 | P8 |
| Large leap | 6, 8-11, 13+ | TT, m6, M6, m7, M7, compound |

**Code**: `dissonanceScoring.js:getIntervalMagnitude()` (lines 189-197).

---

## Short Note

A note whose duration is below the sub-subdivision threshold (subdivision / 3). Short notes receive reduced penalties:

- Consecutive dissonance penalty: halved if on off-beat
- Motion/parallel penalties: halved if the interval is NOT repeated
- Repetition penalties: halved

Thresholds by meter:
- 4/4: subdivision = 0.5 (eighth), threshold ~ 0.167 (triplet eighth)
- 6/8: subdivision = 0.333, threshold ~ 0.111

**Code**: `dissonanceScoring.js:getShortNoteInfo()`, `getShortNoteThreshold()`.

---

## Passingness / Passing Character

A measure of how ornamental or fleeting a dissonant note is. High passingness reduces (mitigates) penalties that would otherwise apply to a note's entry motion and exit resolution. It does **not** affect pattern bonuses, consonance resolution rewards, or the strong-beat metric penalty.

### Passingness Score

A continuous value computed per voice by `scorePassingMotion()`. The voice with the higher passingness is selected as `bestPassing`; per-voice values (`v1Passing`, `v2Passing`) are used for single-voice resolution penalties.

**Base eligibility** — a note receives non-zero passingness only if its duration ≤ 0.5 quarter-note units (eighth note or shorter).

**Contributing factors:**

| Factor | Points | Condition |
|--------|--------|-----------|
| Base (short note) | +0.5 | Duration ≤ eighth note (always first) |
| Off-beat position | +0.5 | `metricWeight < 0.5` (off the primary subdivision) |
| Step entry | +0.75 | Melodic interval 1-2 semitones into this note |
| Oblique entry | +0.5 | One voice moves by step while the other holds |
| Sequence membership | +1.0 | Onset falls within a detected melodic sequence |

**Thresholds:**

| Value | Meaning |
|-------|---------|
| `passingness = 0` | Not short enough — no mitigation |
| `0 < passingness < 1` | Partial passing — some mitigation |
| `passingness ≥ 1` | `isPassing = true` — full passing-tone character |

**Mitigation amount** (applied to penalties):

```
mitigation = passingness / 2
```

Example: passingness 1.75 → mitigation 0.875. A similar-motion penalty of -0.50 becomes `min(0, -0.50 + 0.875) = 0` (fully negated).

### Standalone vs Consecutive Dissonances

Passingness applies to **all dissonances**, not just those in a D→D chain:

- **Standalone dissonance**: A single dissonant note surrounded by consonances. Before this revision, passingness was never computed for these. Now it is — so a CS playing a quick offbeat 16th note in oblique motion can receive passingness ≈ 1.75 and have its entry/exit penalties substantially mitigated.
- **Consecutive dissonance**: Part of a D→D chain. Passingness additionally mitigates the -0.75 base D→D exit penalty.

**Code**: `dissonanceScoring.js:scorePassingMotion()`, Pass 1 and Pass 2 in `analyzeAllDissonances()`.

---

## Dissonance Chain

A sequence of two or more consecutive dissonant simultaneities, where each resolves not to a consonance but directly to another dissonance.

### Chain Roles

| Field | Meaning |
|-------|---------|
| `isChainEntry` | First dissonance of the chain (C→D) |
| `isConsecutiveDissonance` | Second or later member (D→D) |
| `isChainResolution` | First consonance after the chain ends |
| `chainStartOnset` | Beat position of the first chain member |
| `chainEndOnset` | Beat position of the last chain member |
| `chainLength` | Total number of dissonant simultaneities in the chain |
| `chainPosition` | 0-indexed position of this member within the chain |
| `chainUnresolved` | `true` if the chain reaches the end of the passage without resolving |

### Chain Scoring

The chain entry (`isChainEntry`) bears the D→D exit penalty (-0.75) for moving into the chain. Each consecutive member also bears this penalty. These are stored separately as `baseExitComponent` in the exit info and can be mitigated by passingness.

### Chain Visualization

In the detail panel, chains are shown as a motion diagram (the outer wrapper with a purple dashed border). Tapping any note in the chain reveals the full chain from entry through resolution (or "Unresolved" if it never resolves). This diagram is not repeated — it appears once regardless of where in the chain you tap.

**Code**: `dissonanceScoring.js:analyzeAllDissonances()` — chain labeling pass (~line 1700). `TwoVoiceViz.jsx` — chain motion diagram (~line 856).

---

## Per-Voice Mitigation (Pass 1 / Pass 2)

After all dissonances are scored by `_scoreDissonance`, `analyzeAllDissonances` runs two additional passes to apply passingness mitigations.

### Pass 1 — Compute Passingness

For every dissonant simultaneity (`!isConsonant`), compute:
- `v1Passing` — passingness of the V1 melodic line entering this dissonance
- `v2Passing` — passingness of the V2 melodic line entering this dissonance
- `bestPassing` — whichever voice has higher passingness

Fields stored on each result:
- `passingMotion` = `bestPassing`
- `v1PassingMotion` = `v1Passing`
- `v2PassingMotion` = `v2Passing`

For consecutive members only (`isConsecutiveDissonance`):
- `consecutiveMitigationCount` — number of mitigating factors present
- `consecutiveMitigation` — `bestPassing.mitigation` value
- `isPassing` — `true` if `bestPassing.passingness ≥ 1`

### Pass 2 — Apply Mitigations Per Component

For each dissonance with `passingMotion` set:

| Component | Mitigation Used | Rule |
|-----------|----------------|------|
| Entry motion penalty (similar/parallel) | `bestPassing.mitigation` | Penalty → `min(0, penalty + mitigation)`. Cannot flip to reward. |
| Entry motion reward (oblique/contrary) | `bestPassing.mitigation` | Reward reduced by `min(0.8, mitigation/2.5)`. Cannot flip to penalty. |
| V1 exit resolution penalty | `v1Passing.mitigation` | Penalty → `min(0, penalty + v1Mit)`. |
| V2 exit resolution penalty | `v2Passing.mitigation` | Penalty → `min(0, penalty + v2Mit)`. |
| D→D base exit penalty | `bestPassing.mitigation` | **Consecutive members only.** Penalty → `min(0, penalty + mitigation)`. |

The total adjustment is stored as `passingCharacterAdj` and appended to `results[i].details` as a "Passing character (label): +X.XX [...]" line.

**Code**: `dissonanceScoring.js:analyzeAllDissonances()` Pass 1 (~line 1766) and Pass 2 (~line 1826).

---

## Dissonance Treatment Patterns

Each dissonance is evaluated in three phases: **Entry** (C -> D), **Dissonance** (type/position), **Exit** (D -> C or D -> D).

### Suspension / Retardation
Oblique entry on a strong beat, step resolution by the held voice. Suspension resolves downward; retardation resolves upward.

- Entry bonus: +0.75 (oblique preparation)
- Exit bonus: +0.5 (step resolution) + 0.25 if downward
- Total: +1.25 to +1.5

**Code**: `dissonanceScoring.js:checkPatterns()` lines 791-826.

### Appoggiatura
Leap or skip entry on a strong beat, step resolution in the opposite direction.

- Entry bonus: +2.0 (offsets leap penalty)
- Exit bonus: +0.5
- Total: +2.5

**Code**: `dissonanceScoring.js:checkPatterns()` lines 850-898.

### Cambiata (Nota Cambiata)
Step entry followed by a skip of a 3rd in the same direction.

| Variant | Label | Beat | Entry Bonus | Exit Bonus | Total |
|---------|-------|------|-------------|------------|-------|
| Traditional (descending) | Cam | Weak | +0.3 | +1.2 | +1.5 |
| Inverted (ascending) | Cam^ | Weak | +0.2 | +0.8 | +1.0 |
| Strong beat (descending) | Cam? | Strong | +0.1 | +0.4 | +0.5 |
| Strong beat (inverted) | Cam^? | Strong | +0.1 | +0.4 | +0.5 |

**Code**: `dissonanceScoring.js:checkPatterns()` lines 901-999.

### Escape Tone (Echappee)
Step entry, skip or leap exit in the opposite direction.

- Bonus: +0.5

**Code**: `dissonanceScoring.js:checkPatterns()` lines 1002-1026.

### Passing Tone (PT)
Stepwise through in the same direction on a weak beat.

- Bonus: 0 (no penalty, no reward — this is baseline acceptable)

**Code**: `dissonanceScoring.js:checkPatterns()` lines 1028-1047.

### Neighbor Tone (N)
Step out and step back (opposite direction) on a weak beat.

- Bonus: 0 (baseline acceptable)

**Code**: `dissonanceScoring.js:checkPatterns()` lines 1049-1068.

### Anticipation (Ant)
Oblique entry on a weak beat — one voice arrives early. Non-parallel exit.

- Bonus: +0.5

**Code**: `dissonanceScoring.js:checkPatterns()` lines 828-848.

### Unprepared Dissonance
A strong-beat dissonance not matching any recognized pattern. Scores poorly due to no pattern bonus to offset the strong-beat penalty.

---

## Resolution

### Resolution to consonance
When a dissonance (D) moves to a consonance (C):
- To imperfect consonance (3rd, 6th): +1.0
- To perfect consonance (unison, P5, P8): +0.5

### Resolution to dissonance (D -> D)
When a dissonance leads to another dissonance. This creates a **dissonance chain** (see below).
- Normal: -0.75 (stored as `baseExitComponent`)
- Short note on off-beat: -0.375 (halved)

The chain entry (`isChainEntry`) bears this penalty for moving into the chain. Each consecutive member (`isConsecutiveDissonance`) also bears it for moving to the next dissonance. This penalty can be mitigated by passingness (see **Per-Voice Mitigation**).

### Resolution by abandonment
One voice drops out (rests) leaving the dissonance unresolved: -0.5.

### Phantom note
A note conceptually extends for `duration / 2` beats into a following rest. If the rest exceeds this phantom duration, the resolution is considered delayed (-0.3).

**Code**: `dissonanceScoring.js:scoreExit()` (lines 568-760).

---

## Entry/Exit Score Components

Each dissonance's total score is the sum of two independently tracked sub-scores:

### entryScore
Combines: entry motion base score + strong-beat penalty + pattern entry bonuses + (cross-referenced) leap→exit penalty preview.

Stored as `result.entryScore` and `result.entry.score` (pre-mitigation base). After Pass 2, `entryScore` reflects the mitigated value.

### exitScore
Combines: exit resolution base score + exit pattern bonuses + voice-resolution leap penalties.

Stored as `result.exitScore` and `result.exit.score` (pre-mitigation base). After Pass 2, `exitScore` reflects the mitigated value.

### Cross-Reference (Entry → Exit Penalty)

When a voice enters a dissonance by leap (P4/P5, skip, large leap), the resolution penalty is computed in `scoreExit` (because it depends on how the leap is resolved) but is **also previewed in the Entry Motion section** of the detail panel. This makes it clear that the entry leap is causally linked to any exit penalty incurred.

Display format in Entry Motion: "V1 P4/P5 leap → exit: -1.50"

**Code**: `dissonanceScoring.js:_scoreDissonance()` — cross-reference inserted after `exitInfo` is computed (~line 1524). Stored in `entryInfo.details`.

---

## Parallel Fifths and Octaves

Two consecutive simultaneities where both are P5 (or both P1/P8) and both voices move in the same direction. A critical voice-leading error in all contexts.

Detection: Both voices must actually move (not just one). Direction of both voices must match.

**Code**: `vizConstants.js:isParallelFifthOrOctave()`. Also checked in stretto, invertibility, and modulatory robustness analyses.

---

## Sequence Mitigation

When a dissonance occurs within a detected melodic sequence, leap penalties are reduced by 75% (`penalty *= 0.25`). Sequences create their own structural logic that justifies intervals that would otherwise be problematic.

**Code**: `dissonanceScoring.js:scoreExit()` — checks `isOnsetInSequence()`. Multiplier defined in `constants.js:ANALYSIS_THRESHOLDS.SEQUENCE_PENALTY_MULT`.

---

## Score Categories

### Base-Zero System
- **0** = Acceptable baseline (neutral, unremarkable)
- **Positive** = Strengths (higher = better)
- **Negative** = Weaknesses (lower = more problematic)

Overall score = weighted average of active categories.

### Categories

| # | Category | UI Label | Weight | Group | Code Function |
|---|----------|----------|--------|-------|---------------|
| 1 | Rhythmic Character | Rhythmic Character | 0.8 | Melodic | `scoring.js:scoreRhythmicCharacter()` |
| 2 | Stretto Potential | Stretto Potential | 1.0 | Fugal | `scoring.js:scoreStrettoPotential()` |
| 3 | Answer Compatibility | Answer Compatibility | 0.9 | Fugal | Part of tonal answer scoring |
| 4 | Invertibility | Invertibility | 1.0 | Combination | `scoring.js:scoreInvertibility()` |
| 5 | Rhythmic Interplay | Rhythmic Interplay | 0.8 | Combination | `scoring.js:scoreRhythmicInterplay()` |
| 6 | Voice Independence | Voice Independence | 0.9 | Combination | `scoring.js:scoreVoiceIndependence()` |
| 7 | Transposition Stability | Answer vs CS | 1.0 | Combination | `scoring.js:scoreTranspositionStability()` |

- Without countersubject: categories 1-3 only (Melodic + Fugal groups)
- With countersubject: all 7 categories

**Code**: `scoring.js:calculateOverallScore()`.

### Score Interpretation

| Score Range | Rating | Meaning |
|-------------|--------|---------|
| >= 15 | Strong | Notably strong fugue material |
| 5 to 14 | Good | Good fugue material |
| 0 to 4 | Fair | Acceptable, unremarkable |
| < 0 | Weak | Below acceptable baseline |

---

## Visualization Color Semantics

### Consonances
| Type | Color | Hex |
|------|-------|-----|
| Perfect (P1, P5, P8) | Teal | `#14b8a6` |
| Imperfect (3rds, 6ths) | Lime | `#84cc16` |
| Repeated interval | Grey | `#a3a3a3` |

### Dissonances (purple -> red, by entry + pattern score)
| Rating | Color | Hex | Score |
|--------|-------|-----|-------|
| Excellent | Indigo | `#6366f1` | >= 2.0 |
| Very good | Violet | `#7c3aed` | >= 1.5 |
| Good | Violet | `#8b5cf6` | >= 1.0 |
| Acceptable | Purple | `#a855f7` | >= 0.5 |
| Marginal | Fuchsia | `#c026d3` | >= 0 |
| Poor | Pink | `#db2777` | >= -0.5 |
| Bad | Rose | `#e11d48` | >= -1.0 |
| Very bad | Red | `#dc2626` | < -1.0 |

### Resolutions (emerald -> amber, by exit score)
| Rating | Color | Hex | Score |
|--------|-------|-----|-------|
| Excellent | Emerald | `#10b981` | >= 1.0 |
| Very good | Green | `#22c55e` | >= 0.75 |
| Good | Lime | `#84cc16` | >= 0.5 |
| Acceptable | Yellow | `#eab308` | >= 0.25 |
| Marginal | Amber | `#f59e0b` | >= 0 |
| Poor | Orange | `#f97316` | >= -0.5 |
| Weak | Orange | `#fb923c` | < -0.5 |

### Violations (always red)
| Type | Color | Hex |
|------|-------|-----|
| Parallel 5ths/8ves | Red | `#dc2626` |
| Consecutive dissonance | Red | `#ef4444` |
| Unresolved dissonance | Amber | `#f59e0b` |

### Voice Colors
| Voice | Color | Hex |
|-------|-------|-----|
| Subject / Dux | Indigo | `#6366f1` |
| Answer / Comes | Orange | `#f97316` |
| Countersubject (above) | Emerald | `#10b981` |
| Countersubject (below) | Amber | `#f59e0b` |

**Code**: `vizConstants.js:VIZ_COLORS`, `getIntervalStyle()`, `getDissonanceColorByEntryScore()`, `getResolutionColorByExitScore()`.

---

## Consonance Context Rules

### Consecutive Perfect Intervals
3+ consecutive perfect intervals (unison, P5, P8): -0.5 per extra beyond 2.

### Consecutive Imperfect Consonances
4+ consecutive 3rds: -0.25 per extra beyond 3.
4+ consecutive 6ths: -0.25 per extra beyond 3.

**Code**: `dissonanceScoring.js` consonance context scoring.

---

## ABC Notation (Input Format)

### Pitch
- `C D E F G A B` = octave below middle C to B
- `c d e f g a b` = middle C octave
- `'` = up one octave, `,` = down one octave

### Accidentals (prefix the note)
- `^` = sharp, `_` = flat, `=` = natural

### Duration (suffix the note, multiplies default note length)
- `2` = double, `3` = triple, `/2` = half, `3/2` = 1.5x

### Headers
- `K:D` = D major, `K:Dm` = D minor
- `L:1/8` = default note length is eighth note
- `M:3/4` = time signature

### Spelling Key vs Analysis Key
The spelling key determines how ABC accidentals are parsed. The analysis key determines scale degree interpretation. These can differ — e.g., spell in C major (explicit accidentals) but analyze as D minor.

**Code**: `abcParser.js:parseABC()`, `constants.js:KEY_SIGNATURES`.

---

## Glossary of Abbreviations

| Abbreviation | Meaning |
|-------------|---------|
| CS | Countersubject |
| PT | Passing tone |
| N | Neighbor tone |
| Ant | Anticipation |
| App | Appoggiatura |
| Cam | Cambiata |
| Esc | Escape tone |
| Sus | Suspension |
| P1 | Perfect unison |
| P4 | Perfect fourth |
| P5 | Perfect fifth |
| P8 | Perfect octave |
| m2/M2 | Minor/major second |
| m3/M3 | Minor/major third |
| m6/M6 | Minor/major sixth |
| m7/M7 | Minor/major seventh |
| TT | Tritone |
| V1/V2 | Voice 1 / Voice 2 |
| D -> C | Dissonance resolving to consonance |
| D -> D | Dissonance leading to another dissonance |
| C -> D | Consonance moving to dissonance (entry) |
| Sim | Simultaneity |
| Mit | Mitigation / mitigation value |
| overallAvgScore | Duration-weighted average score across all intervals (consonances + dissonances) |
| averageScore | Unweighted average score across dissonances only |
